--001

CREATE DOMAIN UserType AS SMALLINT;		--0 guest, 1 developer, 2 admin;

-------------------------------------------------------------------------------------------------------------------------

--002

CREATE TABLE User_ (

	user_id SERIAL PRIMARY KEY,
	email VARCHAR(50) UNIQUE NOT NULL,
	hashed_password CHAR(64) NOT NULL,
	user_type UserType NOT NULL DEFAULT 0,

	CONSTRAINT correct_mail_format CHECK( mail LIKE '%@%.%' AND mail NOT LIKE '%@%@%')
	--controllo ci sia una e una sola @ e almeno un punto

);

-------------------------------------------------------------------------------------------------------------------------

--003

CREATE TABLE Project (

	project_id SERIAL PRIMARY KEY,
	project_name TEXT NOT NULL,

	CONSTRAINT correctness_of_project_name_min_length CHECK( LENGTH(project_name) > 0 )

);

-------------------------------------------------------------------------------------------------------------------------

--004

CREATE TABLE Team (

	team_id SERIAL PRIMARY KEY,
	team_name TEXT NOT NULL,
	project_id INTEGER NOT NULL,

	CONSTRAINT project_FK FOREIGN KEY(project_id) REFERENCES Project(project_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT correctness_of_team_name_min_length CHECK( LENGTH(team_name) > 0 )

);

-------------------------------------------------------------------------------------------------------------------------

--005

CREATE TYPE IssueType AS ENUM ('BUG', 'DOCUMENTATION', 'FEATURE', 'QUESTION');

-------------------------------------------------------------------------------------------------------------------------

--006

CREATE TYPE IssueStatus AS ENUM ('ASSIGNED', 'RESOLVED', 'TODO');

-------------------------------------------------------------------------------------------------------------------------

--007

CREATE DOMAIN PriorityType AS SMALLINT;		

--0 molto bassa, 
--1 bassa, 
--2 normale, 
--3 alta, 
--4 molto alta;

-------------------------------------------------------------------------------------------------------------------------

--008

CREATE TABLE Issue (

	issue_id SERIAL PRIMARY KEY,
	title VARCHAR(100) NOT NULL,
	issue_description TEXT NOT NULL,
	issue_priority PriorityType NOT NULL DEFAULT 2,
	issue_image TEXT,
	issue_type IssueType NOT NULL,
	issue_status IssueStatus NOT NULL DEFAULT 'TODO',
	tags TEXT,
	report_time TIMESTAMP NOT NULL,
	resolution_time TIMESTAMP,
	reporter_id INTEGER NOT NULL DEFAULT 0,
	resolver_id INTEGER NOT NULL DEFAULT 0,
	project_id INTEGER NOT NULL,

	CONSTRAINT reporter_FK FOREIGN KEY(reporter_id) REFERENCES User_(user_id) ON DELETE SET DEFAULT ON UPDATE CASCADE,
	CONSTRAINT resolver_FK FOREIGN KEY(resolver_id) REFERENCES User_(user_id) ON DELETE SET DEFAULT ON UPDATE CASCADE,
	CONSTRAINT project_FK FOREIGN KEY(project_id) REFERENCES Project(project_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT resolution_after_report CHECK( resolution_time > report_time),
	CONSTRAINT issue_priority_not_negative CHECK(issue_priority >= 0)

);

-------------------------------------------------------------------------------------------------------------------------

--009

CREATE TABLE Works_on (

	project_id INTEGER NOT NULL,
	user_id INTEGER NOT NULL,

	CONSTRAINT project_FK FOREIGN KEY(project_id) REFERENCES Project(project_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT user_FK FOREIGN KEY(user_id) REFERENCES User_(user_id) ON DELETE CASCADE ON UPDATE CASCADE

);

-------------------------------------------------------------------------------------------------------------------------

--010

CREATE TABLE Works_in (

	team_id INTEGER NOT NULL,
	user_id INTEGER NOT NULL,

	CONSTRAINT team_FK FOREIGN KEY(team_id) REFERENCES Team(team_id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT user_FK FOREIGN KEY(user_id) REFERENCES User_(user_id) ON DELETE CASCADE ON UPDATE CASCADE

);

-------------------------------------------------------------------------------------------------------------------------
